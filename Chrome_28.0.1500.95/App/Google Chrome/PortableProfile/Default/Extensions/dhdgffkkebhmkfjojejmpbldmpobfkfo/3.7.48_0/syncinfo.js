(function(){Registry.require("xmlhttprequest",function(){var x=Registry.get("xmlhttprequest").run,t=!1,u=1,y=null,n=0,v=null,f={ePASTEBIN:1,eCHROMESYNC:2},q={},r=[],u=3,g=!1,p=null,z=[{method:"HEAD",url:"http://www.google.com",extract:function(a,b){try{var c=b?b.split("\n"):null,e;for(e in c){var d=c[e].split(":"),m=d.shift()||"",h=d.join(":")||"";if("date"==m.trim().toLowerCase()&&h){var s=new Date(h);if(s)return s.getTime()-(new Date).getTime()}}}catch(g){}return null}},{method:"GET",url:"http://json-time.appspot.com/time.json",
extract:function(a,b){try{var c=JSON.parse(a);if(!c.error&&c.datetime){var e=new Date(c.datetime);if(e)return e.getTime()-(new Date).getTime()}}catch(d){}return null}}];q[f.ePASTEBIN]="http://pastebin.com/raw.php?i=%s";q[f.eCHROMESYNC]="";var A=function(){return(new Date).getTime()+p},B=function(a){var b=0,c=function(){if(b<z.length){var e=z[b];x({method:e.method,url:e.url},{onload:function(d){4==d.readyState&&(200==d.status?(d=e.extract(d.responseText,d.responseHeaders),null===d?(b++,window.setTimeout(c,
1)):(p=d,a&&a(!0))):(b++,window.setTimeout(c,1)))}})}else p=0,console.log("si: time offset detection failed!"),a&&a(!1)};c()},D=function(){if(!t)try{chrome.storage.onChanged.addListener(C),t=!0}catch(a){}},C=function(a,b){if(n==f.eCHROMESYNC&&"sync"==b)if(null===p)B(function(){C(a,b)});else{var c=/@us$/,e;for(e in a){var d=a[e];if(-1!=e.search(c))for(var m=0;m<r.length;m++)if(!l[e]){var h=w(d.newValue);if(h)r[m](e,h)}}}},G=function(a){v?x({method:"GET",retries:u,url:v},{onload:function(b){if(4==b.readyState)if(200==
b.status){b=b.responseText;var c=[];try{b=b.replace(/\t/g,"    ");b=b.replace(/\r/g,"\n");b=b.replace(/\n\n+/g,"\n");for(var e=b.split("\n"),d=0;d<e.length;d++){var m=e[d],h=m.split("|");if(3<h.length)console.log("si: can't handle line: "+m);else{var s=h[h.length-1],g=null,l=null;if(1<h.length)for(var f=h.length-2;0<=f;f--)try{g=JSON.parse(h[f])}catch(k){l=h[f]}c.push({name:l,url:s,options:g||{}})}}}catch(n){console.warn("si: unable to parse data: "+b)}a&&a(c)}else a&&a([])}}):a&&a([])},w=function(a,
b){var c=null;try{c=JSON.parse(a)}catch(e){}return c&&c.url?c:null},H=function(a){var b=arguments,c=function(){b.callee.apply(this,b)};if(g)window.setTimeout(c,500);else{var e=/@us$/,c=function(b){var c=[],d;for(d in b)if(-1!=d.search(e)){var f=d.replace(e,""),k=null;(k=l[d]?w(l[d],d):w(b[d],d))&&c.push({id:f,name:f.replace(/20/g," "),url:k.url,options:k.options?k.options:{}})}g=!1;a&&a(c)};g=!0;try{chrome.storage.sync.get(null,c)}catch(d){console.warn("si: error accessing storage: "+d.message),g=
!1,a&&window.setTimeout(function(){a(null)},1)}return null}},k=null,l={},E=function(a,b){var c=arguments,e=function(){c.callee.apply(this,c)};if(g)window.setTimeout(e,500);else{void 0===b&&(b=u);var d=function(a){(a=chrome.runtime?chrome.runtime.lastError:a)?(console.log("si: error on write "+a.message),0<--b&&window.setTimeout(e,6E4)):l={};g=!1};g=!0;try{chrome.storage.sync.set(l,d)}catch(f){d(f)}}},F=function(a){if(null===p)B(function(){F(a)});else return n==f.eCHROMESYNC?H(a):G(a)};Registry.register("syncinfo",
"48",{init:function(a,b){r=[];var c=!1;y=b;n=a;a==f.eCHROMESYNC?(D(),c=!0):q[n]&&y&&(v=q[n].replace("%s",b),c=!0);return c},list:F,add:function(a,b){l[a.id+"@us"]=JSON.stringify({url:a.url,options:a.options});k&&window.clearTimeout(k);k=window.setTimeout(E,3E3);b&&b()},reset:function(a){var b=arguments,c=function(){b.callee.apply(this,b)};if(g)window.setTimeout(c,500);else{g=!0;c=function(){l={};g=!1;a&&a()};try{chrome.storage.sync.clear(c)}catch(e){console.warn("si: error clearing storage: "+
e.message),window.setTimeout(c,1)}}},getTime:A,remove:function(a,b){var c={url:a.url,options:a.options||{}};c.options.removed=A();l[a.id+"@us"]=JSON.stringify(c);k&&window.clearTimeout(k);k=window.setTimeout(E,3E3);b&&b()},debug:function(a){},addChangeListener:function(a){r.push(a);t||D()},types:f})})})();
